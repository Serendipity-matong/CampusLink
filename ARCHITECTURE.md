# CampusLink 架构设计文档

## 1. 系统架构概览

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户端 (User-End)                        │
│         H5应用  │  微信小程序  │  APP应用  │  后台管理            │
└──────────────────────────┬──────────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────────┐
│                      静态层 (Static Layer)                       │
│              Vue  │  uni-app  │  Nuxt  │  Element UI            │
└──────────────────────────┬──────────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────────┐
│                      接入层 (Access Layer)                       │
│                  Nginx  │  WAF防火墙  │  CDN                     │
└──────────────────────────┬──────────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────────┐
│                      网关层 (Gateway Layer)                      │
│         Apache APISIX  │  路由  │  鉴权  │  限流  │  熔断        │
└──────────────────────────┬──────────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────────┐
│                   服务注册发现 (Service Discovery)               │
│                    Consul  │  健康检查  │  配置中心               │
└──────────────────────────┬──────────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────────┐
│                  微服务集群 (Microservice Cluster)               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ auth-srv │  │ user-srv │  │product-  │  │ task-srv │        │
│  │          │  │          │  │   srv    │  │          │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │order-srv │  │payment-  │  │ search-  │  │ admin-   │        │
│  │          │  │   srv    │  │   srv    │  │   srv    │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
│  ┌──────────┐                                                    │
│  │ biz-srv  │    基于 Go-Kratos + gRPC                          │
│  │          │                                                    │
│  └──────────┘                                                    │
└──────────────────────────┬──────────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────────┐
│                   数据层 (Data Layer)                            │
│  MySQL  │  Redis  │  NATS  │  Elasticsearch  │  MinIO           │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈对比

| 模块 | mall4cloud (Java) | CampusLink (Go) |
|------|-------------------|-----------------|
| 核心框架 | Spring Cloud | Go-Kratos |
| ORM | MyBatis | GORM |
| 服务注册 | Nacos | Consul |
| 网关 | Spring Cloud Gateway | Apache APISIX |
| 负载均衡 | Spring Cloud Loadbalancer | gRPC 内置 LB |
| 服务调用 | Feign | gRPC |
| 分布式事务 | Seata | DTM |
| 缓存 | Redis | Redis (go-redis) |
| 消息队列 | RocketMQ | NATS JetStream |
| 搜索 | Elasticsearch | Elasticsearch |
| 定时任务 | XXL-JOB | gocron |
| 文件存储 | MinIO | MinIO |
| 数据同步 | Canal | Debezium/go-mysql |
| 文档 | Knife4j | go-swagger |

## 2. 微服务设计

### 2.1 服务拆分原则

1. **单一职责原则**: 每个服务只负责一个业务领域
2. **高内聚低耦合**: 服务内部高度相关，服务间松散耦合
3. **数据独立**: 每个服务拥有独立的数据库
4. **无状态设计**: 服务本身不保存状态，状态存储在Redis
5. **可独立部署**: 服务可以独立开发、测试、部署

### 2.2 服务列表

#### 2.2.1 auth-srv - 认证授权服务
- **职责**: 用户登录、注册、Token管理
- **端口**: gRPC 9001, HTTP 10001
- **数据库表**: user (共享)
- **关键功能**:
  - JWT Token 生成和验证
  - 多种登录方式 (用户名/手机号/学号)
  - 密码加密存储
  - Token 刷新机制

#### 2.2.2 user-srv - 用户服务
- **职责**: 用户信息管理、学生认证
- **端口**: gRPC 9002, HTTP 10002
- **数据库表**: user, user_stats
- **关键功能**:
  - 用户信息CRUD
  - 学生身份认证
  - 用户角色管理
  - 用户统计信息

#### 2.2.3 product-srv - 二手书/租借品服务
- **职责**: 商品管理、库存管理
- **端口**: gRPC 9003, HTTP 10003
- **数据库表**: product, product_image
- **关键功能**:
  - 商品发布/编辑/删除
  - 商品上下架
  - 库存管理 (支持DTM分布式事务)
  - 商品分类和筛选

#### 2.2.4 task-srv - 跑腿/代课服务
- **职责**: 任务管理、任务匹配
- **端口**: gRPC 9004, HTTP 10004
- **数据库表**: task, task_rating
- **关键功能**:
  - 任务发布/接单/完成
  - 任务状态流转
  - 任务评价
  - 任务推荐

#### 2.2.5 order-srv - 订单服务
- **职责**: 订单管理、订单流程编排
- **端口**: gRPC 9005, HTTP 10005
- **数据库表**: order, order_item
- **关键功能**:
  - 订单创建 (调用product-srv扣减库存)
  - 订单状态管理
  - 订单评价
  - 退款申请

#### 2.2.6 payment-srv - 支付服务
- **职责**: 支付处理、退款管理
- **端口**: gRPC 9006, HTTP 10006
- **数据库表**: payment, refund, wallet
- **关键功能**:
  - 第三方支付集成 (微信/支付宝)
  - 余额支付
  - 退款处理
  - 账户余额管理

#### 2.2.7 search-srv - 搜索服务
- **职责**: 全文搜索、搜索推荐
- **端口**: gRPC 9007, HTTP 10007
- **数据存储**: Elasticsearch
- **关键功能**:
  - 商品搜索
  - 任务搜索
  - 用户搜索
  - 搜索建议和热词

#### 2.2.8 admin-srv - 后台管理服务
- **职责**: 后台管理、数据统计
- **端口**: gRPC 9008, HTTP 10008
- **关键功能**:
  - 用户管理 (封禁/解封)
  - 内容审核
  - 举报处理
  - 系统统计

#### 2.2.9 biz-srv - 通用业务服务
- **职责**: 短信、文件上传、通知
- **端口**: gRPC 9009, HTTP 10009
- **数据库表**: notification, sms_log
- **关键功能**:
  - 短信验证码发送
  - MinIO 文件上传
  - 消息通知推送

## 3. 数据架构

### 3.1 数据库设计

#### 3.1.1 核心表结构

**用户表 (user)**
```sql
- id: 主键
- username: 用户名 (唯一)
- password: 密码 (bcrypt加密)
- phone: 手机号 (唯一)
- student_id: 学号
- verified: 是否认证
- role: 角色 (student/seller/runner/admin)
- status: 状态 (active/banned)
- credit_score: 信用分
- balance: 余额
```

**商品表 (product)**
```sql
- id: 主键
- name: 商品名称
- category: 分类
- product_type: 类型 (sale/rent)
- price: 价格
- stock: 库存
- seller_id: 卖家ID
- status: 状态 (online/offline/sold_out)
```

**任务表 (task)**
```sql
- id: 主键
- title: 标题
- task_type: 类型 (errand/substitute)
- reward: 报酬
- publisher_id: 发布者ID
- executor_id: 接单者ID
- status: 状态 (pending/accepted/completed/cancelled)
```

**订单表 (order)**
```sql
- id: 主键
- order_no: 订单号 (唯一)
- buyer_id: 买家ID
- seller_id: 卖家ID
- order_type: 类型 (product_sale/product_rent/task)
- total_amount: 总金额
- status: 状态 (pending/paid/completed/cancelled)
```

### 3.2 缓存策略

| 缓存类型 | Key格式 | 过期时间 | 说明 |
|---------|---------|---------|------|
| 用户信息 | user:{id} | 1小时 | 用户基本信息 |
| Token黑名单 | token:blacklist:{token} | 7天 | 已登出的Token |
| 商品详情 | product:{id} | 30分钟 | 商品详细信息 |
| 商品库存 | product:stock:{id} | 实时 | 库存数量 |
| 热搜词 | search:hot | 5分钟 | 热搜关键词 |
| 验证码 | sms:code:{phone} | 5分钟 | 短信验证码 |

### 3.3 消息队列主题

| 主题名称 | 作用 | 消费者 |
|---------|------|--------|
| order.created | 订单创建 | payment-srv, biz-srv |
| order.paid | 订单支付 | order-srv, biz-srv |
| product.updated | 商品更新 | search-srv |
| task.accepted | 任务接单 | biz-srv |
| user.registered | 用户注册 | biz-srv |

## 4. 应用分层架构 (Kratos)

### 4.1 分层说明

```
┌─────────────────────────────────────┐
│  HTTP/gRPC Handler (入口层)          │
│  - 接收请求                           │
│  - 参数校验                           │
│  - 返回响应                           │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│  Service (服务层)                    │
│  - DTO ↔ BO 转换                     │
│  - 业务编排                           │
│  - 调用 Biz 层                        │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│  Biz (业务逻辑层)                     │
│  - 核心业务逻辑                        │
│  - 处理 BO                            │
│  - 调用 Data 层                       │
│  - 调用其他服务的 gRPC Client          │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│  Data (数据访问层)                    │
│  - PO ↔ BO 转换                      │
│  - GORM 操作                         │
│  - Redis 操作                        │
│  - 数据持久化                         │
└─────────────────────────────────────┘
```

### 4.2 对象转换

- **DTO (Data Transfer Object)**: 用于HTTP/gRPC传输
- **BO (Business Object)**: 用于业务逻辑层
- **PO (Persistent Object)**: 用于数据持久化

## 5. 部署架构

### 5.1 本地开发环境

```bash
# 启动基础服务
docker-compose up -d

# 启动微服务
make build && make run-all
```

### 5.2 Kubernetes 生产环境

- 使用 Deployment 部署微服务
- 使用 Service 暴露服务
- 使用 ConfigMap 管理配置
- 使用 HPA 自动扩缩容
- 使用 Ingress 统一入口

## 6. 监控和治理

### 6.1 链路追踪
- **工具**: Jaeger
- **端口**: 16686
- **功能**: 分布式链路追踪

### 6.2 指标监控
- **工具**: Prometheus + Grafana
- **端口**: 9090 (Prometheus), 3000 (Grafana)
- **功能**: 服务性能监控、告警

### 6.3 日志聚合
- **工具**: ELK Stack (可选)
- **功能**: 集中日志管理和分析

## 7. 安全设计

### 7.1 认证授权
- JWT Token 认证
- 基于角色的访问控制 (RBAC)
- API 签名验证

### 7.2 数据安全
- 密码 bcrypt 加密
- 敏感数据加密传输 (HTTPS)
- SQL 注入防护 (GORM 参数化查询)

### 7.3 接口安全
- 限流 (基于 APISIX)
- 防刷 (Redis + 令牌桶)
- 黑白名单

## 8. 性能优化

### 8.1 缓存策略
- 多级缓存 (本地缓存 + Redis)
- 缓存预热
- 缓存穿透/击穿/雪崩防护

### 8.2 数据库优化
- 索引优化
- 读写分离
- 分库分表 (未来扩展)

### 8.3 服务优化
- 连接池复用
- gRPC 连接复用
- 异步处理 (使用NATS)

## 9. 扩展性设计

### 9.1 水平扩展
- 无状态服务设计
- 支持多实例部署
- 负载均衡

### 9.2 垂直扩展
- 资源配置可调
- 支持容器化部署

### 9.3 业务扩展
- 插件化设计
- 事件驱动架构
- 微服务独立演进


